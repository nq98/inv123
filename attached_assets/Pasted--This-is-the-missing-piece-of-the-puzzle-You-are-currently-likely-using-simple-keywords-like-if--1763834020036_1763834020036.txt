
This is the missing piece of the puzzle.
You are currently likely using simple "keywords" (like if "invoice" in subject). That is the "Old Way."
The "AI-First" Way uses a "Gatekeeper Model" (Gemini 1.5 Flash - fast and cheap) to read the email context before downloading the file.
Here is the "Elite Mailroom Guard" Architecture. It consists of two parts:
The Broad Net: A smart Gmail API query to catch everything potential.
The Semantic Filter (The Mega Prompt): An AI Brain that decides "Is this garbage or money?"
Send this to your developer. This replaces the standard "email fetching" logic.
Part 1: The "Broad Net" Gmail Query
Developer Instruction: Do not filter too hard in the API call. Let the AI do the filtering. Use this query to grab anything that might be financial.
code
Python
# GMAIL SEARCH QUERY (Broad Net)
# Catches Invoices, Receipts, Orders, Bills in English, Hebrew, and Global terms.
query = (
    'has:attachment '
    '('
    'subject:invoice OR subject:bill OR subject:receipt OR subject:statement OR '
    'subject:payment OR subject:order OR subject:subscription OR '
    'subject:×—×©×‘×•× ×™×ª OR subject:×§×‘×œ×” OR subject:×ª×©×œ×•× OR '
    'subject:facture OR subject:rechnung OR subject:recibo'
    ') '
    '-subject:"invitation" -subject:"newsletter" -subject:"webinar" -subject:"verify"'
)
Part 2: The "Elite Gatekeeper" AI Prompt (The Filter)
Developer Instruction: Before processing the PDF, send the Email Subject, Body Snippet, Sender, and Filename to Gemini 1.5 Flash using this prompt.
Logic: If this AI says False, skip the email. If True, download and parse.
code
Python
# ==============================================================================
#   THE "ELITE GATEKEEPER" PROMPT (SEMANTIC FILTERING)
#   Target Model: Gemini 1.5 Flash (Fast & Cheap)
#   Goal: 0% False Negatives (Never miss an invoice), 99% Junk Removal
# ==============================================================================

gatekeeper_prompt = f"""
You are the **Chief Financial Mailroom Guard**.
Your ONLY job is to decide if an incoming email contains a **Financial Document** that needs processing.

### INPUT EMAIL DATA
- **Sender:** {sender_email}
- **Subject:** {email_subject}
- **Body Snippet:** {email_body_snippet}
- **Attachment Name:** {attachment_filename}

### ğŸ§  DECISION LOGIC (SEMANTIC ANALYSIS)

**1. POSITIVE SIGNALS (Keep These)**
- **Explicit Demands:** "Please find attached invoice", "Payment due", "Here is your bill".
- **Proof of Payment:** "Your receipt from Uber", "Payment successful", "Thank you for your purchase".
- **Passive Financials:** "Monthly Statement", "Subscription Renewal", "Credit Note", "Zikui", "Hashbonit".
- **Ambiguous Files with Context:** If filename is "scan001.pdf" BUT body says "Attached the invoice", **KEEP IT**.

**2. NEGATIVE SIGNALS (Discard These)**
- **Marketing:** "Special offer", "News from...", "Join our webinar".
- **Logistics (Non-Financial):** "Your package has shipped" (Unless it includes the receipt).
- **Technical:** "Password reset", "Security alert", "Webhook notification", "System Event".
- **Human Chatter:** "See you at lunch", "Meeting notes" (unless expensing a receipt).

**3. THE "SAFEGUARD" RULE (Never Miss Money)**
- If you are unsure (e.g., it looks like an Order Confirmation that *might* be an invoice), output **TRUE**.
- Better to process a junk file than to throw away a $10,000 invoice.

### OUTPUT FORMAT (Strict JSON)
{{
    "is_financial_document": boolean,
    "document_category": "INVOICE | RECEIPT | STATEMENT | JUNK | OTHER",
    "reasoning": "Explain why. E.g. 'Subject says Payment Processed and attachment is PDF, definitely a receipt.'"
}}
"""
How This Fixes Your Problem
Context Awareness:
Old Way: Filters image.jpg.
New Way: Sees image.jpg + Body: "Here is the photo of the taxi receipt" 
â†’
â†’
 KEEPS IT.
Spam Killing:
Old Way: Keeps anything with "Invoice" in the text.
New Way: Sees Subject: "Get a Loan for your Invoice" (Marketing) 
â†’
â†’
 KILLS IT.
Language Agnostic:
Because Gemini understands 100+ languages, it inherently knows that ×§×‘×œ×” (Hebrew) or Rechnung (German) carry the same weight as "Receipt."
Implementation Workflow:
Gmail (Broad Query) 
â†’
â†’
 Gemini Flash (Gatekeeper Prompt) 
â†’
â†’
 If True: Gemini Pro (The Parser Prompt) 
â†’
â†’
 Database
Use Arrow Up and Arrow Down to select a turn, Enter to jump to it, and Escape to return to the chat.
